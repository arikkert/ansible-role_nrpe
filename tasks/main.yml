---
# tasks file for role-nrpe
#

- name: ensure packages are installed for RedHat 8/9
  ansible.builtin.dnf:
    enablerepo:
      - powertools
      - epel-testing
    name:
      - nrpe-selinux
      - nrpe
      - nagios-plugins-all
      - nagios-plugins-uptime
  when: ansible_os_family == 'RedHat' and (ansible_distribution_major_version | int) >= 8
- name: ensure packages are installed for RedHat 7
  ansible.builtin.yum:
    name:
      - nrpe-selinux
      - nrpe
      - nagios-plugins-all
      - nagios-plugins-uptime
  when: ansible_os_family == 'RedHat' and (ansible_distribution_major_version | int) < 8
# comment out a line :
#   https://www.mydailytutorials.com/uncommentcomment-lines-files-using-ansible/
# allowed hosts will be in configured in a config file in /etc/nrpe.d/
- name: ensure nrpe is configured - part 01 - main config file
  ansible.builtin.replace:
    path: /etc/nagios/nrpe.cfg
    regexp: '^allowed_hosts=(.*)'
    replace: '#allowed_hosts=\1 # Line managed by Ansible'
    backup: true
  notify: nrpe reload
- name: ensure npre is configured - part 02a - define some checks
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /etc/nrpe.d/
    mode: 0644
  notify: nrpe reload
  loop:
    - common.cfg
    - check_sestatus.cfg
- name: ensure npre is configured - part 02b - define allowed_hosts
  ansible.builtin.template:
    src: "{{ item }}"
    dest: /etc/nrpe.d/allowed_hosts.cfg
    mode: 0644
  notify: nrpe reload
  loop:
    - allowed_hosts.cfg.j2
- name: ensure nrpe is configured - part 03 - add extra plugin
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /usr/lib64/nagios/plugins/
    mode: 0755
  notify: nrpe reload
  loop:
    - check_sestatus
- name: ensure nrpe is running
  ansible.builtin.service:
    name: nrpe
    state: started
    enabled: true
- name: ensure firewall is configured to allow nrpe requests
  ansible.builtin.firewalld:
    state: enabled
    port: "{{ item }}"
    immediate: true
    permanent: true
  loop:
    - 5666/tcp

...
